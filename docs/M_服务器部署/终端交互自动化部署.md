---
title: 终端交互自动化部署
categories:
- M_服务器部署
date: 2020-07-23 21:20:15
tags:
---

## 一、安装 Homebrew

brew之于mac，类似于yum之于linux

```bash
$ /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
```

## 二、安装 expect

#### expect 介绍：

一种与终端交互的工具

```bash
$ brew install expect
```

## 三、测试expect

以下文件命名为 ssh-my-server.sh

```bash
#!/usr/bin/expect
spawn ssh root@120.24.33.53
expect "*password"
send "mypassword\n"
expect "]#"
send "cd /\n"
expect "]#"
send "mkdir testexpect\n"
expect "]#"
send "exit\n"
expect eof
```

 在终端执行 expect ssh-my-server.sh

以上脚本的意思是 连接服务器然后创建一个文件夹，成功后断开服务器连接

## 四、打包并部署项目

结合 bash 与 expect 任务，

```bash
#!/bin/bash
# 进入项目根目录
cd ~/desktop/epic-frontend/
# 执行构建项目
gulp build-noserver
# 压缩打包后的文件
zip -r dist.zip dist

# 开始 expect 交互
expect << EOF
# 开启一个线程任务(上传压缩后的项目到服务器)
spawn scp dist.zip root@120.22.44.55:/install/app/
# 如果匹配到*password
expect "*password"
# 发送密码并回车(\n)执行
send "123456\n"
# 结束当前 spawn
expect eof

# 开启一个新的 expect 交互任务
spawn ssh root@10.253.156.130
# 匹配到*password
expect "*password"
# 发送密码
send "123456\n"
# 匹配到]#，说明上一条命令已经执行完成
expect "]#"
# 进入某个目录
send "cd /install/app/\n"
# 匹配到]#，说明上一条命令已经执行完成
expect "]#"
# 覆盖解压所有文件
send "unzip -o dist.zip\n"
# 匹配到]#，说明上一条命令已经执行完成
expect "]#"
# 将当前目录下的文件信息打印在终端
send "ll\n"
# 匹配到]#，说明上一条命令已经执行完成
expect "]#"
# 执行项目部署任务(构建镜像、推入仓库、启用镜像等操作)
send "python build.py\n"
expect "]#"
# 断开远程服务器连接
send "exit\n"
# expect 交互结束
EOF
```

## expect知识

expect脚本一般以#!/usr/bin/expect -f开头，类似bash脚本。

expect脚本常常以.exp、.ex、.sh结束。

### expect主要命令

-   spawn 新建一个进程，这个进程的交互由expect控制
-   expect 等待接受进程返回的字符串，直到超时时间，根据规则决定下一步操作
-   send 发送字符串给expect控制的进程
-   set 设定变量为某个值
-   exp_continue 重新执行expect命令分支
-   [lindex $argv 0] 获取expect脚本的第1个参数
-   [lindex $argv 1] 获取expect脚本的第2个参数
-   set timeout -1 设置超时方式为永远等待
-   set timeout 30 设置超时时间为30秒
-   interact 将脚本的控制权交给用户，用户可继续输入命令
-   expect eof 等待spawn进程结束后退出信号eof

### expect命令分支

expect命令采用了tcl的模式-动作语法，此语法有以下几种模式：

#### 单一分支语法

```bash
set password 123456
expect "*assword:" { send "$password\r" }
```

当输出中匹配*assword:时，输出password变量的数值和回车。

#### 多分支模式语法

```bash
set password 123456
expect {
      "(yes/no)?" { send "yes\r"; exp_continue }
      "*assword:" { send "$password\r" }
}
```

当输出中包含(yes/no)?时，输出yes和回车,同时重新执行此多分支语句。

当输出中匹配*assword:时，输出password变量的数值和回车。